
CREATE DATABASE olist

CREATE TABLE olist_sellers_dataset
( seller_id varchar(50) NOT NULL PRIMARY KEY, 
seller_zip_code_prefix int,
seller_city varchar (100) NOT NULL,
seller_state varchar(15) NOT NULL
)
COPY olist_sellers_dataset(seller_id ,seller_zip_code_prefix, seller_city, seller_state) 
FROM '/Users/adelaelezaj/desktop/brazilian-ecommerce/olist_sellers_dataset.csv' DELIMITER ',' CSV HEADER;

CREATE TABLE products (
product_id int NOT NULL PRIMARY KEY,
product_category name VARCHAR(70),
product_name length int NOT NULL,
product_description_length int,
product_photos_qty int,
product_weight_g int NOT NULL,
product_length_cm int NOT NULL,
product_height_cm int NOT NULL,
product_width_cm int NOT NULL)

COPY products (product_id, product_category_name, product_name_length, product_description_length, product_photos_qty, product_weight_g, product_length_cm, product_height_cm, product_width_cm)
FROM  '/Users/adelaelezaj/desktop/brazilian-ecommerce/olist_products_dataset.csv' DELIMITER ',' CSV HEADER;

CREATE TABLE product_category_name_translation (
product_category_name VARCHAR(50) NOT NULL,
product_category_name_english VARCHAR(70) NOT NULL)

COPY product_category_name_translation (product_category_name, product_category_name_english) 
FROM '/Users/adelaelezaj/desktop/brazilian-ecommerce/product_category_name_translation.csv' DELIMITER ',' CSV HEADER;


CREATE TABLE customers (
	customer_id varchar (50) NOT NULL PRIMARY KEY,
	customer_unique_id varchar(50),
	customer_zip_code int,
	customer_city varchar (50),
	customer_state varchar (50)
	)
COPY customers (customer_id, customer_unique_id, customer_zip_code, customer_city, customer_state) 
FROM '/Users/adelaelezaj/desktop/brazilian-ecommerce/olist_customers_dataset.csv' DELIMITER ',' CSV HEADER; 

CREATE TABLE geolocation
	(geolocation_zip_code_prefix int,
	 geolocation_lat float,
	 geolocation_Ing float,
	 geolocation_city varchar (50),
	 geolocation_state varchar (10)
	)
COPY geolocation (geolocation_zip_code_prefix, geolocation_lat, geolocation_Ing, geolocation_city, geolocation_state) 
FROM '/Users/adelaelezaj/desktop/brazilian-ecommerce/olist_geolocation_dataset.csv' DELIMITER ',' CSV HEADER; 

CREATE TABLE reviews
	 (review_id varchar (50) NOT NULL,
	 order_id varchar (50),
	 review_score int,
	 review_comment_title varchar (50),
	 review_comment_message varchar (500),
	 review_creation_date timestamp,
	 review_answer_timestamp timestamp)

COPY reviews ( review_id, order_id, review_score, review_comment_title, review_comment_message, review_creation_date, review_answer_timestamp)
FROM '/Users/adelaelezaj/desktop/brazilian-ecommerce/olist_order_reviews_dataset.csv' DELIMITER ',' CSV HEADER;


CREATE TABLE orders (
	order_id VARCHAR(100) PRIMARY KEY,
	customer_id VARCHAR(100),
	order_status VARCHAR(50),
	order_purchase_timestamp TIMESTAMP,
	order_approved_at TIMESTAMP,
	order_delivered_carrier_date TIMESTAMP,
	order_delivered_customer_date TIMESTAMP,
	order_estimated_delivery_date TIMESTAMP
	)
COPY orders (order_id, customer_id, order_status, order_purchase_timestamp, order_approved_at, order_delivered_carrier_date, order_delivered_customer_date,order_estimated_delivery_date)
FROM '/Users/adelaelezaj/desktop/brazilian-ecommerce/olist_orders_dataset.csv' DELIMITER ',' CSV HEADER;

CREATE TABLE order_payments (
	order_id varchar(50),
	payment_sequential int,
	payment_type varchar (50),
	payment_installments int,
	payment_value float)

COPY order_payments(order_id, payment_sequential, payment_type, payment_installments, payment_value)
FROM '/Users/adelaelezaj/desktop/brazilian-ecommerce/olist_order_payments_dataset.csv' DELIMITER ',' CSV HEADER;

CREATE TABLE order_items (
	order_id varchar NOT NULL,
	order_item_id varchar (50),
	product_id varchar (50),
	seller_id varchar (50),
	shipping_limit_date timestamp,
	price float,
	freight_value float)

COPY order_items (order_id, order_item_id, product_id, seller_id, shipping_limit_date, price,freight_value)
FROM '/Users/adelaelezaj/desktop/brazilian-ecommerce/olist_order_items_dataset.csv' DELIMITER ',' CSV HEADER;



--first query
with orders_within_6_mnths AS (
    SELECT c.customer_unique_id, date(o.order_purchase_timestamp) as dt
    FROM orders AS o
    JOIN customers AS c USING (customer_id)
    GROUP BY 1,2
    ORDER by 1
 ),
purchases_within_6mth AS (
    SELECT customer_unique_id, order_id, MIN(dt) as first_order, 
    MIN(dt) + interval '6 months' as order_after_6mth, payment_value
    FROM orders_within_6_mnths
    JOIN customers USING (customer_unique_id)
    JOIN orders USING (customer_id)
    JOIN order_payments USING (order_id)
    GROUP BY 1,2, payment_value
 )
    SELECT distinct(customer_unique_id), first_order, 
    EXTRACT(YEAR FROM first_order) as year,
    EXTRACT(MONTH FROM first_order) as month, date(order_after_6mth),
    count(distinct order_id) AS number_of_orders, sum(payment_value) AS total_payments
    FROM purchases_within_6mth
    GROUP BY 1,2,3,4,5
    ORDER BY number_of_orders desc;

    --&output

     customer_unique_id        | first_order | year | month |    date    | number_of_orders | total_payments 
----------------------------------+-------------+------+-------+------------+------------------+----------------
 8d50f5eadf50201ccdcedfb9e2ac8455 | 2017-05-15  | 2017 |     5 | 2017-11-15 |               17 |         927.63
 3e43e6105506432c953e165fb2acf44c | 2017-09-18  | 2017 |     9 | 2018-03-18 |                9 |        1172.66
 1b6c7548a2a1f9037c1fd3ddfed95f33 | 2017-11-13  | 2017 |    11 | 2018-05-13 |                7 |         959.01
 6469f99c1f9dfae7733b25662e7f1782 | 2017-09-19  | 2017 |     9 | 2018-03-19 |                7 |         758.83
 ca77025e7201e3b30c44b472ff346268 | 2017-10-09  | 2017 |    10 | 2018-04-09 |                7 |        1122.72
 12f5d6e1cbf93dafd9dcc19095df0b3d | 2017-01-05  | 2017 |     1 | 2017-07-05 |                6 |         110.72
 47c1a3033b8b77b3ab6e109eb4d5fdf3 | 2017-08-07  | 2017 |     8 | 2018-02-07 |                6 |         944.21

-- first query modified

with orders_within_6_mnths AS (
    SELECT c.customer_unique_id, date(o.order_purchase_timestamp) as dt
    FROM orders AS o
    JOIN customers AS c USING (customer_id)
    GROUP BY 1,2
    ORDER by 1
 ),
purchases_within_6mth AS (
    SELECT customer_unique_id, order_id, MIN(dt) as first_order, 
    MIN(dt) + interval '6 months' as order_after_6mth, payment_value, customer_state
    FROM orders_within_6_mnths
    JOIN customers USING (customer_unique_id)
    JOIN orders USING (customer_id)
    JOIN order_payments USING (order_id)
    GROUP BY 1,2, payment_value, customer_state
 )
    SELECT distinct(customer_unique_id), first_order, 
    EXTRACT(YEAR FROM first_order) as year,
    EXTRACT(MONTH FROM first_order) as month, date(order_after_6mth) as after_6mth,
    count(distinct order_id) AS number_of_orders,sum(payment_value) as total_payment, ROUND(avg(payment_value)) AS avg_payments, customer_state, ROUND(avg(review_score),2) as avg_score
    FROM purchases_within_6mth
    JOIN reviews USING (order_id)
    GROUP BY 1,2,3,4,5, customer_state
    ORDER BY number_of_orders desc;

--output

 customer_unique_id        | first_order | year | month |    after_6mth    | number_of_orders | avg_payments | customer_state | avg_score 
----------------------------------+-------------+------+-------+------------+------------------+--------------+----------------+-----------
 8d50f5eadf50201ccdcedfb9e2ac8455 | 2017-05-15  | 2017 |     5 | 2017-11-15 |               17 |           55 | SP             |      4.76
 3e43e6105506432c953e165fb2acf44c | 2017-09-18  | 2017 |     9 | 2018-03-18 |                9 |          130 | SP             |      2.78
 1b6c7548a2a1f9037c1fd3ddfed95f33 | 2017-11-13  | 2017 |    11 | 2018-05-13 |                7 |          120 | MG             |      5.00

 --created a view of the query ouput to then later export to a csv file

 CREATE VIEW customers_view AS (query above)

\copy (SELECT * FROM customers_view)  TO '/Users/adelaelezaj/Desktop/brazilian-ecommerce/olist_table.csv' DELIMITER ',' CSV HEADER;
